name: Update Tax News

on:
  schedule:
    - cron: '0 * * * *'  # 每小時運行一次
  push:
    branches:
      - main

jobs:
  update-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'  # 使用 Node.js 版本 14

      - name: Install dependencies
        run: npm install axios cheerio  # 安裝必要的依賴包

      - name: Fetch tax news and update JSON
        run: |
          node <<EOF
          const axios = require('axios');
          const cheerio = require('cheerio');
          const fs = require('fs');

          const fetchTaxNews = async () => {
              try {
                  const response = await axios.get('https://law-out.mof.gov.tw/');
                  const html = response.data;
                  const $ = cheerio.load(html);

                  const taxNews = [];

                  // Adjust the selector according to the structure of the target website
                  $('.news-list li').each((index, element) => {
                      const title = $(element).find('a').text().trim();
                      const description = $(element).find('p').text().trim();
                      const url = $(element).find('a').attr('href');

                      taxNews.push({ title, description, url });
                  });

                  fs.writeFileSync('tax-news.json', JSON.stringify(taxNews, null, 2));
              } catch (error) {
                  console.error('Error fetching tax news:', error);
                  process.exit(1);
              }
          };

          fetchTaxNews();
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub 提供的 Token 進行操作

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add tax-news.json
          git commit -m "Update tax news"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub 提供的 Token 進行操作
